{% extends "base.html" %}

{% block title %}RAG Technical Chat{% endblock %}

{% block content %}
<div x-data="chatComponent()" x-init="init()"
    class="container mx-auto max-w-3xl flex flex-col h-screen bg-white shadow-lg rounded-lg">

    <header class="p-4 border-b border-gray-200 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold font-oswald text-gray-800">RAG Technical Chat</h1>
            <p class="text-sm text-gray-500 font-poppins">Conversation ID: {{ thread_id }}</p>
        </div>
        <a href="/"
            class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            New Chat
        </a>
    </header>

    <div id="chat-messages" x-ref="chatMessages" class="flex-grow p-6 space-y-4 overflow-y-auto">
        <div class="flex justify-start">
            <div class="bg-gray-200 text-gray-800 rounded-lg py-2 px-4 max-w-lg">
                <article class="prose max-w-none">
                    <p>Hello! Click the paperclip icon to upload your technical manuals. The upload will start immediately. Once processed, you can ask questions.</p>
                </article>
            </div>
        </div>
    </div>

    <div id="sending-indicator" class="htmx-indicator mx-auto pt-2">
        <p class="text-sm text-gray-500 animate-pulse">Agent is thinking...</p>
    </div>

    <div class="p-4 bg-gray-50 border-t border-gray-200">
        
        <form hx-post="/send_message" hx-target="#chat-messages" hx-swap="beforeend"
            hx-indicator="#sending-indicator" x-on:htmx:before-request="handleUserMessage($event)"
            class="font-poppins">
            <input type="hidden" name="thread_id" value="{{ thread_id }}">
            <input type="file" x-ref="fileInput" @change="uploadFiles" multiple class="hidden" />

            <div class="relative flex items-center">
                <button type="button" @click="$refs.fileInput.click()" :disabled="isUploading"
                        class="p-2 text-gray-500 rounded-full hover:bg-gray-200 focus:outline-none disabled:opacity-50 disabled:cursor-wait">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                    </svg>
                </button>

                <textarea x-ref="textarea" name="message" x-model="message"
                    @keydown.enter.prevent="!$event.shiftKey && $el.closest('form').requestSubmit()"
                    class="w-full p-3 pl-2 pr-20 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none transition overflow-hidden"
                    placeholder="Ask a question about the uploaded documents..." rows="1"
                    x-init="$el.style.height = $el.scrollHeight + 'px'"
                    @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
                    :disabled="!isReadyToChat"></textarea>

                <button type="submit" :disabled="!isReadyToChat || message.trim() === ''"
                    class="absolute right-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Send
                </button>
            </div>
        </form>

        <div x-show="isUploading || uploadStatus" class="mt-3 text-center h-5">
             <div x-show="isUploading" class="flex justify-center items-center">
                <p class="text-sm text-gray-500 animate-pulse">Processing documents...</p>
             </div>
             
            <p x-show="uploadStatus && !isUploading" x-text="uploadStatus"
               :class="{ 'text-green-600': uploadSuccess, 'text-red-600': !uploadSuccess }" class="text-sm"></p>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    function chatComponent() {
        return {
            message: '',
            isUploading: false,
            isReadyToChat: false,
            uploadStatus: '',
            uploadSuccess: false,

            init() {
                const chatMessages = this.$refs.chatMessages;
                const observer = new MutationObserver(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
                observer.observe(chatMessages, { childList: true, subtree: true });
            },

            handleUserMessage(event) {
                const messageText = this.message.trim();
                if (!messageText) {
                    event.preventDefault();
                    return;
                }
                const userMessageHtml = `
                    <div class="flex justify-end">
                        <div class="bg-blue-600 text-white rounded-lg py-2 px-4 max-w-lg break-words">
                            ${messageText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
                        </div>
                    </div>`;
                this.$refs.chatMessages.insertAdjacentHTML('beforeend', userMessageHtml);
                this.message = '';
                this.$nextTick(() => {
                    const textarea = this.$refs.textarea;
                    textarea.style.height = 'auto';
                });
            },

            uploadFiles(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                this.isUploading = true;
                this.uploadStatus = '';
                this.uploadSuccess = false;

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/documents', true);

                xhr.onload = () => {
                    this.isUploading = false;
                    const response = JSON.parse(xhr.responseText);
                    if (xhr.status === 200) {
                        this.uploadSuccess = true;
                        this.isReadyToChat = true;
                        this.uploadStatus = `✅ Success! Indexed ${response.documents_indexed} document(s). You can now ask questions.`;
                    } else {
                        this.uploadSuccess = false;
                        this.uploadStatus = `❌ Error: ${response.message || 'File upload failed.'}`;
                    }
                };

                xhr.onerror = () => {
                    this.isUploading = false;
                    this.uploadSuccess = false;
                    this.uploadStatus = '❌ An error occurred during the upload. Please try again.';
                };

                xhr.send(formData);
                this.$refs.fileInput.value = '';
            }
        }
    }
</script>
{% endblock %}
